# API 404 错误排查指南

## 🔴 问题症状

浏览器控制台显示：
```
:3001/api/analyze:1   Failed to load resource: the server responded with a status of 404 (Not Found)
OverviewPage.jsx:480  AI 分析错误: Error: API 请求失败
```

---

## 🔍 问题原因

API 返回 404 错误，说明：
1. ❌ 后端服务未启动
2. ❌ 后端服务启动失败
3. ❌ 端口 3001 被占用
4. ❌ 路由配置错误

---

## ✅ 解决步骤

### 第1步：检查后端服务是否运行

**打开新的终端窗口，运行：**

```bash
npm run dev:server
```

**预期输出：**
```
╔════════════════════════════════════════╗
║    AI 分析服务已启动                   ║
║    地址: http://localhost:3001         ║
║    API: POST /api/analyze              ║
║    健康检查: GET /health               ║
╚════════════════════════════════════════╝
```

如果看到上述输出，说明后端服务正常运行。

### 第2步：测试后端连接

**在浏览器中访问：**

```
http://localhost:3001/health
```

**预期响应：**
```json
{
  "status": "ok",
  "timestamp": "2024-11-23T05:22:00.000Z"
}
```

如果看到 JSON 响应，说明后端服务可以正常连接。

### 第3步：检查环境变量

**确保 `.env.local` 文件存在且配置正确：**

```bash
# 查看 .env.local 内容
type .env.local
```

**应该包含：**
```
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxx
```

如果 API Key 为空或不存在，AI 分析会失败。

### 第4步：运行 API 测试脚本

**执行测试脚本：**

```bash
node 测试后端API.js
```

**预期输出：**
```
🧪 开始测试后端 API...

【测试1】健康检查
✅ 后端服务正常运行
   状态: ok
   时间: 2024-11-23T05:22:00.000Z

【测试2】API Key 配置检查
✅ DEEPSEEK_API_KEY 已配置

【测试3】AI 分析接口
发送请求到 /api/analyze...

✅ API 连接成功，开始接收流式数据...

【AI 分析结果】

根据数据分析...
```

---

## 🐛 常见问题

### 问题1：后端服务启动失败

**症状：** 运行 `npm run dev:server` 后立即退出或报错

**解决方案：**

1. **检查依赖是否安装：**
   ```bash
   npm install
   ```

2. **检查 Node.js 版本：**
   ```bash
   node --version
   ```
   需要 Node.js 14+

3. **查看详细错误信息：**
   ```bash
   npm run dev:server 2>&1
   ```

### 问题2：端口 3001 被占用

**症状：** 错误信息：`Error: listen EADDRINUSE: address already in use :::3001`

**解决方案：**

**Windows：**
```bash
# 查看占用端口 3001 的进程
netstat -ano | findstr :3001

# 杀死该进程（假设 PID 为 12345）
taskkill /PID 12345 /F
```

**macOS/Linux：**
```bash
# 查看占用端口 3001 的进程
lsof -i :3001

# 杀死该进程（假设 PID 为 12345）
kill -9 12345
```

### 问题3：API Key 配置错误

**症状：** 后端运行正常，但 AI 分析返回错误

**解决方案：**

1. **验证 API Key 格式：**
   - 应该以 `sk-` 开头
   - 长度通常为 50+ 字符

2. **检查 `.env.local` 文件：**
   ```bash
   # 确保文件存在
   dir .env.local
   
   # 查看内容
   type .env.local
   ```

3. **重新启动后端服务：**
   ```bash
   # 停止当前服务（Ctrl+C）
   # 然后重新启动
   npm run dev:server
   ```

### 问题4：前端无法连接到后端

**症状：** 浏览器控制台显示 404 或连接超时

**解决方案：**

1. **检查前端配置：**
   - 确保前端 API 地址为 `http://localhost:3001`
   - 检查 `.env.local` 中的 `VITE_API_URL`

2. **检查防火墙：**
   - 允许 Node.js 通过防火墙
   - 或者暂时关闭防火墙测试

3. **检查网络连接：**
   ```bash
   # 测试 localhost 连接
   ping localhost
   ```

---

## 🧪 完整诊断流程

按照以下步骤逐一排查：

```
1. ✅ 后端服务是否运行？
   → 运行 npm run dev:server
   
2. ✅ 后端是否可以连接？
   → 访问 http://localhost:3001/health
   
3. ✅ 环境变量是否配置？
   → 检查 .env.local 中的 DEEPSEEK_API_KEY
   
4. ✅ API 是否正常工作？
   → 运行 node 测试后端API.js
   
5. ✅ 前端是否正确配置？
   → 检查 OverviewPage.jsx 中的 API 地址
   
6. ✅ 浏览器是否支持？
   → 使用现代浏览器（Chrome、Edge、Firefox）
```

---

## 📋 快速检查清单

- [ ] 后端服务正在运行（`npm run dev:server`）
- [ ] 可以访问 `http://localhost:3001/health`
- [ ] `.env.local` 文件存在且包含 `DEEPSEEK_API_KEY`
- [ ] API Key 格式正确（以 `sk-` 开头）
- [ ] 没有其他程序占用端口 3001
- [ ] Node.js 版本 14+
- [ ] 前端和后端都已启动
- [ ] 浏览器控制台没有其他错误

---

## 🆘 仍然无法解决？

1. **查看后端日志：**
   ```bash
   # 后端终端窗口应该显示请求日志
   # 例如：[2024-11-23T05:22:00.000Z] POST /api/analyze
   ```

2. **查看浏览器控制台：**
   - 按 F12 打开开发者工具
   - 查看 Console 标签的完整错误信息
   - 查看 Network 标签的请求详情

3. **查看后端错误：**
   ```
   AI 分析错误: ...
   ```

4. **运行诊断工具：**
   ```bash
   诊断AI分析问题.bat
   ```

---

## 📞 获取帮助

1. 查看 `AI分析快速开始.md`
2. 查看 `AI_ANALYSIS_SETUP.md`
3. 查看 `AI分析功能总结.md`
4. 运行 `测试后端API.js`

---

## ✨ 成功标志

当你看到以下现象时，说明问题已解决：

1. ✅ 后端终端显示：`AI 分析服务已启动`
2. ✅ 浏览器访问 `/health` 返回 JSON
3. ✅ 点击"生成AI智能分析报告"按钮后，弹窗出现
4. ✅ AI 分析文本逐字显示（打字机效果）
5. ✅ 分析完成后显示完整的分析报告

祝你使用愉快！🎉
